<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ì—¬ê¸°ì£¼ì°¨</title>

<script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=723a28831bc100497d089cbc3a64e24f&libraries=services&autoload=false"></script>

<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:-apple-system,BlinkMacSystemFont,"Noto Sans KR",sans-serif}

/* í—¤ë” */
.header{
  position:fixed;top:0;left:0;width:100%;height:56px;
  background:#fff;display:flex;align-items:center;justify-content:space-between;
  padding:0 16px;font-weight:700;z-index:3000;
  box-shadow:0 2px 8px rgba(0,0,0,.08);
}
.header button{border:none;background:none;font-size:20px;cursor:pointer}

/* ì§€ë„ */
#map{
  position:fixed;top:56px;left:0;width:100%;
  height:calc(100vh - 56px - 42vh);z-index:1;
}

/* ê²€ìƒ‰ */
.location-bar{
  position:fixed;top:56px;left:0;width:100%;
  background:#fff;padding:12px 16px;z-index:2000;
  box-shadow:0 2px 8px rgba(0,0,0,.08);
}
.location-bar .row{display:flex;gap:8px}
.location-bar input{flex:1;height:40px;border:1px solid #ddd;border-radius:8px;padding:0 12px}
.location-bar button{width:64px;height:40px;border:none;border-radius:8px;background:#000;color:#fff;cursor:pointer}

/* ëª©ë¡ */
.bottom-ui{
  position:fixed;bottom:0;left:0;width:100%;height:42vh;
  background:#fff;border-radius:16px 16px 0 0;
  z-index:2000;box-shadow:0 -4px 16px rgba(0,0,0,.15);
  padding:16px;overflow-y:auto;
}
.item{padding:12px 0;border-bottom:1px solid #eee;cursor:pointer}
.item:hover{background:#f8f9fa}
.item:last-child{border-bottom:none}
.item h3{font-size:15px;margin-bottom:4px}
.item p{font-size:13px;color:#666}
.error{color:#e74c3c;padding:20px;text-align:center}
.loading{color:#666;padding:20px;text-align:center}

/* íŒì—… */
.detail-popup{
  position:fixed;inset:0;background:rgba(0,0,0,.45);
  z-index:4000;display:none;align-items:flex-end;
}
.detail-popup.show{display:flex}
.popup-content{
  width:100%;background:#fff;border-radius:16px 16px 0 0;padding:20px;
}
.popup-info p{
  font-size:14px;margin-bottom:8px;
  display:flex;justify-content:space-between;
}
.nav-btn{
  width:100%;height:48px;border:none;border-radius:10px;
  background:#000;color:#fff;font-size:16px;margin-top:12px;cursor:pointer;
}
.nav-btn:hover{background:#333}
</style>
</head>

<body>

<div class="header">
  ì—¬ê¸°ì£¼ì°¨
  <button id="myLocBtn">ğŸ“</button>
</div>

<div id="map"></div>

<div class="location-bar">
  <div class="row">
    <input id="searchInput" placeholder="ì§€ì—­ ê²€ìƒ‰ (ì˜ˆ: ì„œìš¸ì‹œì²­)">
    <button id="searchBtn">ê²€ìƒ‰</button>
  </div>
</div>

<div class="bottom-ui" id="list">
  <div class="loading">ì£¼ì°¨ì¥ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
</div>

<!-- íŒì—… -->
<div class="detail-popup" id="detailPopup">
  <div class="popup-content" id="popupContent">
    <h2 id="pName" style="margin-bottom:16px"></h2>
    <div class="popup-info">
      <p><strong>ì£¼ì†Œ</strong><span id="pAddr"></span></p>
      <p><strong>ì „í™”ë²ˆí˜¸</strong><span id="pTel"></span></p>
      <p><strong>ì´ìš©í˜„í™©</strong><span id="pStatus"></span></p>
      <p><strong>ì´ ì£¼ì°¨ë©´</strong><span id="pTotal"></span></p>
      <p><strong>ì¥ì• ì¸ ì£¼ì°¨</strong><span id="pHandi"></span></p>
      <p><strong>íŠ¹ìˆ˜ ì£¼ì°¨</strong><span id="pSpecial"></span></p>
    </div>
    <button class="nav-btn" id="navBtn">ê¸¸ì•ˆë‚´</button>
  </div>
</div>

<script>
let map, geocoder, myMarker = null;

// ì¹´ì¹´ì˜¤ë§µ ì´ˆê¸°í™”
function initMap() {
  if (typeof kakao === 'undefined' || !kakao.maps) {
    console.error('ì¹´ì¹´ì˜¤ë§µ APIë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    document.getElementById('map').innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100%;background:#f5f5f5;color:#666;text-align:center;padding:20px;"><div><p style="font-size:16px;margin-bottom:8px;">âš ï¸ ì§€ë„ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</p><p style="font-size:13px;">ì¹´ì¹´ì˜¤ API í‚¤ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”</p></div></div>';
    return false;
  }

  map = new kakao.maps.Map(document.getElementById('map'), {
    center: new kakao.maps.LatLng(37.5665, 126.9780),
    level: 6
  });
  geocoder = new kakao.maps.services.Geocoder();
  return true;
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
window.onload = function() {
  kakao.maps.load(function() {
    const mapReady = initMap();
    setupEventListeners(mapReady);
    loadParkingData(mapReady);
  });
};

// ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
function setupEventListeners(mapReady) {
  /* ë‚´ ìœ„ì¹˜ */
  document.getElementById("myLocBtn").onclick = () => {
    if (!mapReady) {
      alert('ì§€ë„ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }
    navigator.geolocation.getCurrentPosition(pos => {
      const myPos = new kakao.maps.LatLng(pos.coords.latitude, pos.coords.longitude);
      map.panTo(myPos);
      if (myMarker) myMarker.setMap(null);
      myMarker = new kakao.maps.Marker({
        map, position: myPos,
        image: new kakao.maps.MarkerImage(
          "https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png",
          new kakao.maps.Size(24, 35)
        )
      });
    }, err => {
      alert("ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
      console.error(err);
    });
  };

  /* ê²€ìƒ‰ */
  document.getElementById("searchBtn").onclick = () => {
    if (!mapReady) {
      alert('ì§€ë„ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }
    const q = document.getElementById("searchInput").value;
    if (!q) return;
    geocoder.addressSearch(q, (r, s) => {
      if (s === kakao.maps.services.Status.OK) {
        map.panTo(new kakao.maps.LatLng(r[0].y, r[0].x));
      } else {
        alert("ì£¼ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
      }
    });
  };

  /* íŒì—… ë‹«ê¸° */
  document.getElementById("detailPopup").onclick = (e) => {
    if (e.target.id === "detailPopup") {
      document.getElementById("detailPopup").classList.remove("show");
    }
  };
}

// ì£¼ì°¨ì¥ ë°ì´í„° ë¡œë“œ
function loadParkingData(mapReady) {
  const API_KEY = "77426e49686a6577343575774f5963";
  // CORS ìš°íšŒë¥¼ ìœ„í•œ í”„ë¡ì‹œ ì‚¬ìš©
  const originalUrl = `http://openapi.seoul.go.kr:8088/${API_KEY}/json/GetParkingInfo/1/100`;
  const API_URL = `https://api.allorigins.win/raw?url=${encodeURIComponent(originalUrl)}`;

  console.log('API í˜¸ì¶œ ì‹œì‘...');
  
  fetch(API_URL)
  .then(res => {
    console.log("ì‘ë‹µ ìƒíƒœ:", res.status);
    if (!res.ok) {
      throw new Error(`HTTP error! status: ${res.status}`);
    }
    return res.json();
  })
  .then(data => {
    console.log("ë°›ì€ ë°ì´í„°:", data);
    const list = document.getElementById("list");
    list.innerHTML = ""; // ë¡œë”© ë©”ì‹œì§€ ì œê±°
    
    // API ì‘ë‹µ êµ¬ì¡° í™•ì¸
    if (!data.GetParkingInfo) {
      console.error("GetParkingInfo ì—†ìŒ:", data);
      list.innerHTML = `<div class="error">API ì‘ë‹µ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.<br>ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”.</div>`;
      return;
    }
    
    if (!data.GetParkingInfo.row) {
      console.error("row ë°ì´í„° ì—†ìŒ:", data.GetParkingInfo);
      list.innerHTML = `<div class="error">ì£¼ì°¨ì¥ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.<br>${data.GetParkingInfo.RESULT?.MESSAGE || ''}</div>`;
      return;
    }

    const parkingData = data.GetParkingInfo.row;
    console.log(`ì´ ${parkingData.length}ê°œ ì£¼ì°¨ì¥ ë°œê²¬`);

    if (parkingData.length === 0) {
      list.innerHTML = '<div class="error">ì£¼ì°¨ì¥ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
      return;
    }

    parkingData.forEach((p, index) => {
      if (!p.ADDR) {
        console.log(`${index}ë²ˆ ì£¼ì°¨ì¥: ì£¼ì†Œ ì—†ìŒ`, p);
        return;
      }

      const park = {
        name: p.PARKING_NAME || "ì´ë¦„ ì—†ìŒ",
        addr: p.ADDR,
        tel: p.PARKING_TEL || "ì •ë³´ ì—†ìŒ",
        total: Number(p.PARKING_CNT) || 0,
        handi: Number(p.HANDICAP_PARKING) || 0,
        special: p.SPECIAL_PARKING || "ì—†ìŒ"
      };

      const status = 
        park.total >= 300 ? "ì—¬ìœ " :
        park.total >= 100 ? "ë³´í†µ" : "í˜¼ì¡";

      /* ëª©ë¡ ìƒì„± */
      const item = document.createElement("div");
      item.className = "item";
      item.innerHTML = `<h3>${park.name}</h3><p>${status} Â· ${park.addr}</p>`;
      list.appendChild(item);

      item.onclick = () => {
        document.getElementById("pName").textContent = park.name;
        document.getElementById("pAddr").textContent = park.addr;
        document.getElementById("pTel").textContent = park.tel;
        document.getElementById("pStatus").textContent = status;
        document.getElementById("pTotal").textContent = park.total + "ë©´";
        document.getElementById("pHandi").textContent = park.handi + "ë©´";
        document.getElementById("pSpecial").textContent = park.special;
        document.getElementById("detailPopup").classList.add("show");
      };

      /* ì§€ë„ ë§ˆì»¤ - mapReadyì¼ ë•Œë§Œ */
      if (mapReady && geocoder) {
        geocoder.addressSearch(park.addr, (r, s) => {
          if (s !== kakao.maps.services.Status.OK) {
            console.log(`ì£¼ì†Œ ë³€í™˜ ì‹¤íŒ¨: ${park.name} - ${park.addr}`);
            return;
          }
          const pos = new kakao.maps.LatLng(r[0].y, r[0].x);

          new kakao.maps.Marker({
            map, position: pos,
            image: new kakao.maps.MarkerImage(
              `https://maps.google.com/mapfiles/ms/icons/${
                status === "ì—¬ìœ " ? "green" : status === "ë³´í†µ" ? "yellow" : "red"
              }-dot.png`,
              new kakao.maps.Size(32, 32)
            )
          });
        });
      }
    });
  })
  .catch(error => {
    console.error("API í˜¸ì¶œ ì—ëŸ¬:", error);
    const list = document.getElementById("list");
    list.innerHTML = `
      <div class="error">
        <p>ì£¼ì°¨ì¥ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>
        <p style="font-size:12px;margin-top:8px">${error.message}</p>
        <p style="font-size:12px;margin-top:8px">
          1. API í‚¤ë¥¼ í™•ì¸í•˜ì„¸ìš”<br>
          2. ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•˜ì„¸ìš”<br>
          3. ë¸Œë¼ìš°ì € ì½˜ì†”(F12)ì—ì„œ ìì„¸í•œ ì—ëŸ¬ë¥¼ í™•ì¸í•˜ì„¸ìš”
        </p>
      </div>
    `;
  });
}
</script>

</body>
</html>