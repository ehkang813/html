<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Ï£ºÏ†ïÏ∞®OK?</title>

<!-- Ïπ¥Ïπ¥Ïò§Îßµ (services Ìè¨Ìï® ÌïÑÏàò) -->
<script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=723a28831bc100497d089cbc3a64e24f&libraries=services"></script>

<style>
* { box-sizing: border-box; }

body {
  margin: 0;
  font-family: -apple-system, BlinkMacSystemFont, "Noto Sans KR", sans-serif;
  background: #f5f6f8;
  color: #222;
}

/* ===== Ìó§Îçî ===== */
header {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  background: #fff;
  z-index: 1000;
  border-bottom: 1px solid #ddd;
  padding: 10px 14px;
}

.header-top {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

header h1 {
  font-size: 22px;
  font-weight: 700;
}

.loc-btn {
  border: none;
  background: none;
  font-size: 20px;
  cursor: pointer;
}

.search-wrap {
  display: flex;
  gap: 8px;
  margin-top: 8px;
}

.search-wrap input {
  flex: 1;
  padding: 10px;
  font-size: 14px;
  border-radius: 8px;
  border: 1px solid #ccc;
}

.search-wrap button {
  padding: 10px 14px;
  border-radius: 8px;
  border: none;
  background: #1e88e5;
  color: #fff;
  font-size: 14px;
}

/* ===== ÏßÄÎèÑ ===== */
#map {
  margin-top: 112px;
  width: 100%;
  height: 45vh;
}

/* ===== Î¶¨Ïä§Ìä∏ ===== */
.list-wrap {
  background: #fff;
  height: calc(55vh - 112px);
  overflow-y: auto;
  padding: 12px 14px;
}

.list-title {
  font-size: 15px;
  font-weight: 600;
  margin-bottom: 10px;
}

.item {
  padding: 10px 0;
  border-bottom: 1px solid #eee;
}

.item strong {
  display: block;
  font-size: 14px;
}

.item span {
  font-size: 12px;
  color: #666;
}
</style>
</head>
<body>

<header>
  <div class="header-top">
    <h1>Ï£ºÏ†ïÏ∞® OK?</h1>
    <button class="loc-btn" onclick="moveToMyLocation()">üìç</button>
  </div>

  <div class="search-wrap">
    <input type="text" id="searchInput" placeholder="Ï£ºÏÜå Í≤ÄÏÉâ (Ïòà: ÏÑ±ÎÇ®Ïãú Î∂ÑÎãπÍµ¨)">
    <button onclick="searchAddress()">Í≤ÄÏÉâ</button>
  </div>
</header>

<div id="map"></div>

<div class="list-wrap">
  <div class="list-title">Í∞ÄÍπåÏö¥ Ï£ºÏ†ïÏ∞® Îã®ÏÜçÍµ¨Ïó≠</div>
  <div id="list"></div>
</div>

<script>
let map, userLat, userLng;
let markers = [];

/* ÌòÑÏû¨ ÏúÑÏπò */
navigator.geolocation.getCurrentPosition(pos => {
  userLat = pos.coords.latitude;
  userLng = pos.coords.longitude;
  initMap();
  loadData();
});

/* ÏßÄÎèÑ Ï¥àÍ∏∞Ìôî */
function initMap() {
  map = new kakao.maps.Map(document.getElementById("map"), {
    center: new kakao.maps.LatLng(userLat, userLng),
    level: 4
  });

  new kakao.maps.Marker({
    map,
    position: new kakao.maps.LatLng(userLat, userLng)
  });
}

/* ÎÇ¥ ÏúÑÏπò Ïù¥Îèô */
function moveToMyLocation() {
  map.setCenter(new kakao.maps.LatLng(userLat, userLng));
}

/* Ï£ºÏÜå Í≤ÄÏÉâ */
function searchAddress() {
  const keyword = document.getElementById("searchInput").value;
  if (!keyword) return;

  const geocoder = new kakao.maps.services.Geocoder();
  geocoder.addressSearch(keyword, function(result, status) {
    if (status === kakao.maps.services.Status.OK) {
      map.setCenter(new kakao.maps.LatLng(result[0].y, result[0].x));
    }
  });
}

/* Í≥µÍ≥µÎç∞Ïù¥ÌÑ∞ Ìò∏Ï∂ú */
function loadData() {
  fetch(`https://apis.data.go.kr/4090000/NoParkingAreasService/getNoParkingAreaList
?serviceKey=64dfa8ddd0226789d625e94b0537771b1f1d70d23e68899d4914267475e8398d
&pageNo=1&numOfRows=50&type=json`)
    .then(res => res.json())
    .then(data => render(data.response.body.items.item));
}

/* Î¶¨Ïä§Ìä∏ + ÎßàÏª§ Î†åÎçîÎßÅ */
function render(items) {
  const list = document.getElementById("list");
  list.innerHTML = "";
  markers.forEach(m => m.setMap(null));
  markers = [];

  items
    .map(i => {
      const lat = parseFloat(i.latitude);
      const lng = parseFloat(i.longitude);
      if (isNaN(lat) || isNaN(lng)) return null;

      return {
        ...i,
        lat,
        lng,
        distance: calcDistance(userLat, userLng, lat, lng)
      };
    })
    .filter(Boolean)
    .sort((a, b) => a.distance - b.distance)
    .slice(0, 5)
    .forEach(i => {
      const marker = new kakao.maps.Marker({
        map,
        position: new kakao.maps.LatLng(i.lat, i.lng)
      });
      markers.push(marker);

      list.innerHTML += `
        <div class="item">
          <strong>${i.roadNm || i.address || "Ï£ºÏ†ïÏ∞® Îã®ÏÜçÍµ¨Ïó≠"}</strong>
          <span>${Math.round(i.distance)}m</span>
        </div>`;
    });
}

/* Í±∞Î¶¨ Í≥ÑÏÇ∞ */
function calcDistance(lat1, lng1, lat2, lng2) {
  const R = 6371000;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLng = (lng2 - lng1) * Math.PI / 180;
  const a =
    Math.sin(dLat / 2) ** 2 +
    Math.cos(lat1 * Math.PI / 180) *
    Math.cos(lat2 * Math.PI / 180) *
    Math.sin(dLng / 2) ** 2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}
</script>

</body>
</html>
