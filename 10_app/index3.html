<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ì—¬ê¸°ì£¼ì°¨ - ë¶€ì‚°</title>

<script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=723a28831bc100497d089cbc3a64e24f&libraries=services"></script>

<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,"Noto Sans KR",sans-serif;background:#fff}

/* í—¤ë” */
.header{
  height:56px;display:flex;align-items:center;justify-content:space-between;
  padding:0 16px;font-weight:700;
  box-shadow:0 2px 6px rgba(0,0,0,.1);
}
.header button{
  border:none;background:none;font-size:20px;cursor:pointer;
}

/* ê²€ìƒ‰ ì˜ì—­ */
.search{
  display:flex;gap:8px;padding:12px 16px;border-bottom:1px solid #eee;
}
.search input{
  flex:1;height:40px;border:1px solid #ddd;border-radius:8px;padding:0 12px;
}
.search button{
  width:48px;border:none;border-radius:8px;background:#adadad;color:#fff;cursor:pointer;
}

/* ì§€ë„ */
#map{width:100%;height:45vh}

/* ëª©ë¡ */
.list{
  height:calc(55vh - 56px);
  overflow-y:auto;padding:16px;
}
.item{
  padding:12px 0;border-bottom:1px solid #eee;cursor:pointer;
}
.item:hover{background:#f8f9fa}
.item h3{font-size:15px;margin-bottom:4px}
.item p{font-size:13px;color:#666}
.loading{text-align:center;padding:20px;color:#666}
.error{text-align:center;padding:20px;color:#e74c3c}

/* íŒì—… */
.popup{
  position:fixed;inset:0;background:rgba(0,0,0,.4);
  display:none;align-items:flex-end;z-index:9999;
}
.popup.show{display:flex}
.popup-box{
  width:100%;background:#fff;border-radius:16px 16px 0 0;
  padding:20px;
}
.popup-box h2{margin-bottom:16px}
.popup-box p{
  font-size:14px;margin-bottom:8px;
  display:flex;justify-content:space-between;
}
.popup-box button{
  width:100%;height:44px;border:none;border-radius:10px;
  background:#adadad;color:#fff;margin-top:10px;cursor:pointer;
}
.popup-box button:hover{background:#adadad}
</style>
</head>

<body>

<div class="header">
  ì—¬ê¸°ì£¼ì°¨ - ë¶€ì‚°
  <button id="myLocBtn">ğŸ“</button>
</div>

<div class="search">
  <input id="searchInput" placeholder="ë¶€ì‚° ì§€ì—­ ê²€ìƒ‰ (ì˜ˆ: í•´ìš´ëŒ€)">
  <button id="searchBtn">ì°¾ê¸°</button>
</div>

<div id="map"></div>
<div class="list" id="list">
  <div class="loading">ë‚´ ìœ„ì¹˜ë¥¼ í™•ì¸í•˜ëŠ” ì¤‘...</div>
</div>

<div class="popup" id="popup">
  <div class="popup-box">
    <h2 id="pName"></h2>
    <p><strong>ì£¼ì†Œ</strong><span id="pAddr"></span></p>
    <p><strong>ì „í™”</strong><span id="pTel"></span></p>
    <p><strong>ì£¼ì°¨ë©´</strong><span id="pTotal"></span></p>
    <p><strong>ê±°ë¦¬</strong><span id="pDist"></span></p>
    <button id="navBtn">ê¸¸ì•ˆë‚´</button>
  </div>
</div>

<script>
/* ì§€ë„ */
const map = new kakao.maps.Map(document.getElementById("map"), {
  center: new kakao.maps.LatLng(35.1796, 129.0756),
  level: 6
});

const ps = new kakao.maps.services.Places();
const geocoder = new kakao.maps.services.Geocoder();
let myPos = null;
let myMarker = null;

/* ê±°ë¦¬ ê³„ì‚° */
function distance(lat1, lng1, lat2, lng2) {
  const R = 6371e3;
  const toRad = x => x * Math.PI / 180;
  const dLat = toRad(lat2 - lat1);
  const dLng = toRad(lng2 - lng1);
  const a = Math.sin(dLat / 2) ** 2 +
    Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
    Math.sin(dLng / 2) ** 2;
  return Math.round(R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a)));
}

/* ë‚´ ìœ„ì¹˜ */
function setMyLocation() {
  navigator.geolocation.getCurrentPosition(pos => {
    myPos = {
      lat: pos.coords.latitude,
      lng: pos.coords.longitude
    };
    const loc = new kakao.maps.LatLng(myPos.lat, myPos.lng);
    map.panTo(loc);
    
    if (myMarker) myMarker.setMap(null);
    myMarker = new kakao.maps.Marker({
      map, position: loc,
      image: new kakao.maps.MarkerImage(
        "https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png",
        new kakao.maps.Size(24, 35)
      )
    });
    
    console.log('ë‚´ ìœ„ì¹˜ ì„¤ì • ì™„ë£Œ:', myPos);
    
    // ìœ„ì¹˜ í™•ì¸ í›„ ì£¼ì°¨ì¥ ë¡œë“œ
    loadParkingData();
  }, err => {
    console.error('ìœ„ì¹˜ ì˜¤ë¥˜:', err);
    document.getElementById('list').innerHTML = '<div class="error">ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.<br>ìœ„ì¹˜ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.</div>';
  });
}

myLocBtn.onclick = setMyLocation;
setMyLocation();

/* ë¶€ì‚° ê³µê³µì£¼ì°¨ì¥ */
function loadParkingData() {
  if (!myPos) {
    console.log('ë‚´ ìœ„ì¹˜ ëŒ€ê¸° ì¤‘...');
    return;
  }

  const list = document.getElementById("list");
  list.innerHTML = '<div class="loading">ì£¼ì°¨ì¥ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';

  const BUSAN_KEY = "64dfa8ddd0226789d625e94b0537771b1f1d70d23e68899d4914267475e8398d";
  const API_URL = `https://apis.data.go.kr/6260000/BusanPblcPrkngInfoService/getPblcPrkngInfo?serviceKey=${BUSAN_KEY}&pageNo=1&numOfRows=100&resultType=json`;

  console.log('API í˜¸ì¶œ ì‹œì‘...');

  fetch(API_URL)
    .then(r => {
      console.log('ì‘ë‹µ ìƒíƒœ:', r.status);
      return r.json();
    })
    .then(data => {
      console.log('ë°›ì€ ë°ì´í„°:', data);

      const items = data.getPblcPrkngInfo?.body?.items?.item || [];
      console.log(`ì£¼ì°¨ì¥ ê°œìˆ˜: ${items.length}`);

      if (items.length === 0) {
        list.innerHTML = '<div class="error">ì£¼ì°¨ì¥ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
      }

      const results = [];
      let processed = 0;

      items.forEach((p, index) => {
        // ì£¼ì†Œë¡œ ì¢Œí‘œ ê²€ìƒ‰
        if (p.lnmadr) {
          geocoder.addressSearch(p.lnmadr, (result, status) => {
            processed++;

            if (status === kakao.maps.services.Status.OK) {
              const lat = parseFloat(result[0].y);
              const lng = parseFloat(result[0].x);
              const dist = distance(myPos.lat, myPos.lng, lat, lng);

              results.push({
                name: p.prkplceNm || 'ì´ë¦„ ì—†ìŒ',
                addr: p.lnmadr || '',
                tel: p.phoneNumber || 'ì •ë³´ì—†ìŒ',
                total: p.prkcmprt || 'ì •ë³´ì—†ìŒ',
                lat: lat,
                lng: lng,
                dist: dist
              });

              console.log(`${processed}/${items.length} ì²˜ë¦¬ ì™„ë£Œ: ${p.prkplceNm}`);
            }

            // ëª¨ë“  ì²˜ë¦¬ ì™„ë£Œ ì‹œ
            if (processed === items.length) {
              displayResults(results);
            }
          });
        } else {
          processed++;
        }
      });
    })
    .catch(error => {
      console.error('API ì˜¤ë¥˜:', error);
      list.innerHTML = `<div class="error">ì£¼ì°¨ì¥ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.<br>${error.message}</div>`;
    });
}

/* ê²°ê³¼ í‘œì‹œ */
function displayResults(results) {
  const list = document.getElementById("list");
  
  if (results.length === 0) {
    list.innerHTML = '<div class="error">ì£¼ë³€ì— ì£¼ì°¨ì¥ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
    return;
  }

  // ê±°ë¦¬ìˆœ ì •ë ¬
  results.sort((a, b) => a.dist - b.dist);
  console.log(`${results.length}ê°œ ì£¼ì°¨ì¥ í‘œì‹œ`);

  list.innerHTML = "";

  results.forEach(p => {
    // ëª©ë¡ ì•„ì´í…œ
    const item = document.createElement("div");
    item.className = "item";
    item.innerHTML = `<h3>${p.name}</h3><p>${p.dist}m Â· ${p.addr}</p>`;
    list.appendChild(item);

    // ê±°ë¦¬ë³„ ìƒ‰ìƒ
    const color = p.dist < 300 ? "green" : p.dist < 600 ? "yellow" : "red";
    
    // ì§€ë„ ë§ˆì»¤
    const marker = new kakao.maps.Marker({
      map,
      position: new kakao.maps.LatLng(p.lat, p.lng),
      image: new kakao.maps.MarkerImage(
        `https://maps.google.com/mapfiles/ms/icons/${color}-dot.png`,
        new kakao.maps.Size(32, 32)
      )
    });

    // í´ë¦­ ì´ë²¤íŠ¸
    item.onclick = () => {
      document.getElementById('pName').textContent = p.name;
      document.getElementById('pAddr').textContent = p.addr;
      document.getElementById('pTel').textContent = p.tel;
      document.getElementById('pTotal').textContent = p.total;
      document.getElementById('pDist').textContent = p.dist + "m";
      
      document.getElementById('navBtn').onclick = () => {
        window.open(`https://map.kakao.com/link/to/${p.name},${p.lat},${p.lng}`, '_blank');
      };
      
      document.getElementById('popup').classList.add("show");
      map.panTo(new kakao.maps.LatLng(p.lat, p.lng));
    };
  });
}

/* ê²€ìƒ‰ */
searchBtn.onclick = () => {
  const q = searchInput.value;
  if (!q) return;
  geocoder.addressSearch(q, (r, s) => {
    if (s === kakao.maps.services.Status.OK) {
      map.panTo(new kakao.maps.LatLng(r[0].y, r[0].x));
    } else {
      alert('ì£¼ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    }
  });
};

/* íŒì—… ë‹«ê¸° */
popup.onclick = (e) => {
  if (e.target.id === 'popup') {
    popup.classList.remove("show");
  }
};
</script>

</body>
</html>