<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ì—¬ê¸°ì£¼ì°¨</title>

<script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=723a28831bc100497d089cbc3a64e24fY&libraries=services"></script>

<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,"Noto Sans KR",sans-serif;background:#fff}

/* í—¤ë” */
.header{
  height:56px;display:flex;align-items:center;justify-content:space-between;
  padding:0 16px;font-weight:700;
  box-shadow:0 2px 6px rgba(0,0,0,.1);
}

/* ê²€ìƒ‰ ì˜ì—­ */
.search{
  display:flex;gap:8px;padding:12px 16px;border-bottom:1px solid #eee;
}
.search input{
  flex:1;height:40px;border:1px solid #ddd;border-radius:8px;padding:0 12px;
}
.search button{
  width:48px;border:none;border-radius:8px;background:#000;color:#fff;
}

/* ì§€ë„ */
#map{width:100%;height:45vh}

/* ëª©ë¡ */
.list{
  height:calc(55vh - 56px);
  overflow-y:auto;padding:16px;
}
.item{
  padding:12px 0;border-bottom:1px solid #eee;cursor:pointer;
}
.item h3{font-size:15px}
.item p{font-size:13px;color:#666}

/* íŒì—… */
.popup{
  position:fixed;inset:0;background:rgba(0,0,0,.4);
  display:none;align-items:flex-end;
}
.popup.show{display:flex}
.popup-box{
  width:100%;background:#fff;border-radius:16px 16px 0 0;
  padding:20px;
}
.popup-box p{
  font-size:14px;margin-bottom:8px;
  display:flex;justify-content:space-between;
}
.popup-box button{
  width:100%;height:44px;border:none;border-radius:10px;
  background:#000;color:#fff;margin-top:10px;
}
</style>
</head>

<body>

<div class="header">
  ì—¬ê¸°ì£¼ì°¨
  <button id="myLocBtn">ğŸ“</button>
</div>

<div class="search">
  <input id="searchInput" placeholder="ë¶€ì‚° ì§€ì—­ ê²€ìƒ‰ (ì˜ˆ: í•´ìš´ëŒ€)">
  <button id="searchBtn">ğŸ”</button>
</div>

<div id="map"></div>
<div class="list" id="list"></div>

<div class="popup" id="popup">
  <div class="popup-box">
    <h2 id="pName"></h2>
    <p><strong>ì£¼ì†Œ</strong><span id="pAddr"></span></p>
    <p><strong>ì „í™”</strong><span id="pTel"></span></p>
    <p><strong>ì£¼ì°¨ë©´</strong><span id="pTotal"></span></p>
    <p><strong>ê±°ë¦¬</strong><span id="pDist"></span></p>
    <button id="navBtn">ê¸¸ì•ˆë‚´</button>
  </div>
</div>

<script>
/* ì§€ë„ */
const map = new kakao.maps.Map(document.getElementById("map"), {
  center: new kakao.maps.LatLng(35.1796,129.0756),
  level: 6
});

const ps = new kakao.maps.services.Places();
const geocoder = new kakao.maps.services.Geocoder();
let myPos = null;

/* ê±°ë¦¬ ê³„ì‚° */
function distance(lat1,lng1,lat2,lng2){
  const R=6371e3;
  const toRad=x=>x*Math.PI/180;
  const dLat=toRad(lat2-lat1);
  const dLng=toRad(lng2-lng1);
  const a=Math.sin(dLat/2)**2 +
          Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*
          Math.sin(dLng/2)**2;
  return Math.round(R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)));
}

/* ë‚´ ìœ„ì¹˜ */
function setMyLocation(){
  navigator.geolocation.getCurrentPosition(pos=>{
    myPos={
      lat:pos.coords.latitude,
      lng:pos.coords.longitude
    };
    const loc=new kakao.maps.LatLng(myPos.lat,myPos.lng);
    map.panTo(loc);
    new kakao.maps.Marker({
      map,position:loc,
      image:new kakao.maps.MarkerImage(
        "https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png",
        new kakao.maps.Size(24,35)
      )
    });
  });
}
myLocBtn.onclick=setMyLocation;
setMyLocation();

/* ë¶€ì‚° ê³µê³µì£¼ì°¨ì¥ */
const BUSAN_KEY="64dfa8ddd0226789d625e94b0537771b1f1d70d23e68899d4914267475e8398d";

fetch(`https://apis.data.go.kr/6260000/BusanPblcPrkngInfoService/getPblcPrkngInfo?serviceKey=${BUSAN_KEY}&pageNo=1&numOfRows=50&resultType=json`)
.then(r=>r.json())
.then(data=>{
  const items=data.getPblcPrkngInfo?.body?.items?.item||[];
  const list=document.getElementById("list");
  const results=[];

  items.forEach(p=>{
    ps.keywordSearch(p.prkplceNm+" ê³µì˜ì£¼ì°¨ì¥",(r,s)=>{
      if(s!==kakao.maps.services.Status.OK||!myPos) return;

      const pos=r[0];
      const d=distance(myPos.lat,myPos.lng,pos.y,pos.x);

      results.push({
        name:p.prkplceNm,
        addr:p.lnmadr||"",
        tel:p.phoneNumber||"ì •ë³´ì—†ìŒ",
        total:p.prkcmprt||"ì •ë³´ì—†ìŒ",
        lat:pos.y,lng:pos.x,dist:d
      });

      results.sort((a,b)=>a.dist-b.dist);
      list.innerHTML="";

      results.forEach(p=>{
        const item=document.createElement("div");
        item.className="item";
        item.innerHTML=`<h3>${p.name}</h3><p>${p.dist}m Â· ${p.addr}</p>`;
        list.appendChild(item);

        const color=p.dist<300?"green":p.dist<600?"yellow":"red";
        new kakao.maps.Marker({
          map,
          position:new kakao.maps.LatLng(p.lat,p.lng),
          image:new kakao.maps.MarkerImage(
            `https://maps.google.com/mapfiles/ms/icons/${color}-dot.png`,
            new kakao.maps.Size(32,32)
          )
        });

        item.onclick=()=>{
          pName.textContent=p.name;
          pAddr.textContent=p.addr;
          pTel.textContent=p.tel;
          pTotal.textContent=p.total;
          pDist.textContent=p.dist+"m";
          navBtn.onclick=()=>{
            location.href=`https://map.kakao.com/link/to/${p.name},${p.lat},${p.lng}`;
          };
          popup.classList.add("show");
          map.panTo(new kakao.maps.LatLng(p.lat,p.lng));
        };
      });
    });
  });
});

/* ê²€ìƒ‰ */
searchBtn.onclick=()=>{
  const q=searchInput.value;
  if(!q) return;
  geocoder.addressSearch(q,(r,s)=>{
    if(s===kakao.maps.services.Status.OK){
      map.panTo(new kakao.maps.LatLng(r[0].y,r[0].x));
    }
  });
};

popup.onclick=()=>popup.classList.remove("show");
</script>

</body>
</html>
